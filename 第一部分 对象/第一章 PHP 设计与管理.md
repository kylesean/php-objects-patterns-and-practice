## PHP：设计与管理

2004年6月 PHP5.0版本发布了，这是一个彻底增强的版本，其中重要的特性之一便是大大改进了对面向对象编程的支持。它使 PHP 社区开始对“对象”和“设计”产生很大兴趣。事实上，这一趋势从 PHP4 开始支持面向对象编程就已经开始，而PHP5 使这个过程向前跃进了一大步。

本章中，我将介绍使用对象编码的一些需求。我非常简要地总结了模式和相关实践方面的演变，还概述了本书涵盖的主题，包括：

- 灾难的演变：项目变糟糕。
- 设计与PHP：面向对象技术如何深入影响了 PHP 社区。
- 本书：对象、模式与实践。


### 问题
我们所面对的问题在于 PHP 太易于使用了！它吸引你马上实验你的想法，并给出令人满意的结果。你可能会直接在 Web 页面上书写大量代码，因为 PHP 本身就有这样的功能；你也可能会在文件中添加工具函数（如数据库访问代码），然后把文件放到文件页面中，不知不觉中写出来的 Web 应用程序也可以正常运行。

你将陶醉于这条毁灭之路。当然，你并不会意识到这一点，因为你的站点看起来是那么奇妙。站点运行良好，客户也很开心。站点的用户也愿意为之付费。

然而当开始一个新的开发阶段时，再去看以前的代码，问题就出现了。现在你有了一个更大的开发团队、更多的用户和更充足的预算。在没有任何预警的情况下，事态开始恶化，就像你的项目中了毒一样。

新加入的程序员开始费力地理解你的代码，虽然对你而言是件几分钟就能搞定的事，即便代码有些绕。他将会花费超出你想象的时间来成为一个合格的团队成员。

要做一个简单的改变，你发现必须要更新 20 多个页面。这样原本估计只要一天就可完成的工作，实际却用了三天。

一个程序员保存了他对某个文件的修改，而实际上你在较早时候曾对这个文件做了大量修改，于是你修改过的内容全部作废。这个损失在 3 天内都没有发现，因为你有自己本地的副本，你一直在自己的代码上工作。于是你需要整整一天的时间来理清头绪，还要让第三个用到这份文件的程序员也按兵不动。

由于站点受欢迎，访问量增加，你需要将代码迁移到新的服务器上。这需要手动安装，而你发现文件路径、数据库名和密码已经被硬编码（hard-coded）到许多源文件中。因为你不想重写迁移到新服务器所修改的代码，所以迁移过程中必须暂停开发工作。另外，因为某人自作聪明地使用了 Apache 的 URL 重写模块 ModRewrite，网站现在需要这个模块才能正常运转。以上种种原因导致原计划需要的 2 小时变成 8 小时。

最后你开始第二个阶段，并且头一天半一切正常。在你就要下班离开办公室时出现了第一个 bug 报告，几分钟后客户打电话过来抱怨。他的报告和第一个 bug 报告很相似，但是经过更加详细的调查，却发现这是另一个引起类似问题的 bug。你开始回忆在本阶段开始时的简单修改导致对整个项目其余部分所做的大量修改。

这时你认识到的有些修改还不彻底。可能出错的原因是有的在最初就被忽略了，或是出问题的文件在合并时被覆盖了。你急忙进行必要的修改来解决问题。你脚不沾地地忙于测试所做的修改，但只是简单的复制和粘贴，心想应该不会有什么问题吧？

第二天早上你到达办公室后发现，购物车模块一整晚都不能运行了。你最后一分钟的修改漏掉了一个上引号，所以代码就不能用了。自然，在你酣睡期间，其他时区的顾客并没有睡觉，他们本来是有可能到你的网店上来消费的。你解决了这个问题，安抚了客户，并且集合队伍开始另一天的救火行动。

以上这个每天都会发生问题的程序员的故事可能让你觉得有点夸张了，但是我看到现实中这些事情一而再地发生。许多 PHP 项目都是这样一个小项目开始慢慢变成令人恐惧的怪兽。

由于表现层中也包含应用程序逻辑，随着数据库查询、用于验证、表单处理等工作的进行代码被从一个页面复制到另一个页面，重复现象很早就开始在代码中蔓延。每当改动涉及这些代码块之一，那么该代码块出现的每个地方都要改动，否则将出现 bug。

缺少文档使得代码难以阅读，缺少测试则让不明显的错误直到项目部署也未被发现。客户惯于改变需求的天性常常使代码从它原来的用途变为完成根本不适合或不在计划中的任务。这样的代码逐渐成为混杂的一团，所以很难通过替换或重写部分代码来实现新的目标。

当然，如果你一个 PHP 技术顾问，这并不是坏消息。评估和修复一个这样的系统的费用足够你买 6 个月或更长时间昂贵的咖啡和 DVD。但若严肃看待，此类问题通常意味着一个业务的成功或失败。


### PHP 和其他语言

PHP 的流行意味着它的使用范围很早就经过严格测试。就像我们在下一章中看到的那样，PHP 最初用于管理个人主页的宏指令集合。随着 PHP3 和 PHP4 的先后出现，PHP 语言很快成为了大型企业级站点成功的支持力量。尽管如此，PHP 早期的遗留思想直到现在还影响着脚本设计和项目管理。PHP 有时会被误解为一种属于计算机业余爱好者的语言，最适合用于表现层，其实这样说是不公平的，这是一种偏见。

2000 年前后，新思潮开始风行于很多其他编程语言社区。面向对象设计使 Java 社区感到兴奋。你会认为这是一件很自然的事情，因为 Java 就是一种面向对象的语言。Java 提供一种“颗粒”单元（即对象），易于组织和开发。但是，使用类和对象并不意味着这就是一种特殊的设计方式。

在 20 世纪 70 年代，设计模式（Design Pattern）作为一种描述和解决问题的方案第一次被提出。实际上这种想法源自建筑学，而不是计算机科学。在 20 世纪 90 年代初，面向对象编程使用了相同的技术命名和描述设计软件问题。由“四人组（Gang of Four）”著的在1995年出版的 `Design Patterns:Elements of Reusable Objected-Oriented Software` 是里程碑式的设计模式的图书，而且至今仍是不可替代的。该书中介绍的模式是此领域的任何人开始时所必需的第一步，因此本书的大部分模式也都从中选取。

Java 语言本身在其 API 中使用了很多核心模式，但是设计模式到 20 世纪 90 年代末期才开始引起开发社区的密切关注。有关模式的书很快占据了各大书店的计算机书架，并且有人已经开始在邮件列表和论坛上对模式开展激烈讨论。

无论你认为模式是沟通专业知识的强大方式，还是一时的流行性事件（通过本书的书名，你可能已经猜到我要表达的观点），很难否定的是模式对于软件设计方法的关注和强调是很有意义的。

模式相关的话题也渐渐引起关注，其中之一是由 `Kent Beck` 倡导的 XP （xXtreme Programming,极限编程）。XP 是一种针对项目的方法，鼓励灵活的、面向对象设计的、高度集中的计划和执行方法。

XP 的主要原则是主张测试是项目的关键。测试应该是自动化的、经常进行的，并且最好是在目标代码编写前设计好的。

XP同时认为项目应该被划分为小（非常小）的迭代任务。要一直仔细检查代码和需求。架构和设计应该是共享和不变的版本，而代码则可以频繁地进行修改。

如果说 XP 思想为设计发展插上了激进的翅膀，那么要了解软件设计发展相对缓和的趋势，可以看看 `Andrew Hunt` 和 `David Thomos` 著的 2000 年出版的 *`The Pragmatic Programmer`*，它是我读过的关于编程的最好的书之一。


> *The Pragmatic Programmer* 这本书就是大名鼎鼎的『程序员修炼之道』。

XP 曾被一些人认为是幼稚的想法，但是它的成长经过了 20 年来最高水准的面向对象实践的考验，XP 原则也已经被广泛使用。特别是代码修订，即通常所说的重构，被作为模式的强大辅助手段。重构从 20 世纪 80 年代开始发展，但是在 `Martin Flower` 的 *`Rfactoring:Improving the Design of Existing Code`* 一书中才对重构进行了分类和定义，此书已于1999 年出版。

> *Rfactoring:Improving the Design of Existing Code* 『重构：改善既有代码的设计』

随着 XP 和设计模式的流行，测试也成为了一个热点。强大的测试工具 `JUnit` 的发布则使自动测试更加容易，而 `JUnit` 也成为了 Java 程序员武器库中必不可少的一件利器。`Kent Beck` 和 `Erich Gammar` 发表的 `"Test Infected:Programmers Lovers Writing Tests"` (http://junit.sourceforge.net/doc/testinfected/testing.htm)是一篇非常好的介绍测试的文章，并且至今仍有很大影响力。

PHP 4也在这个时期发布，它在效率上有很大提升，更重要的是强化了对对象的支持。这个改进使完全进行面向对象开发变得可能。程序员们都喜欢这个新特性，这让 Zend 公司的创始人 `Zeev Suraski` 和 `Andi Gutmans` （他们和 PHP 创始人 Rasmus Lerdorf 一起参与 PHP 内核的开发）有点吃惊。正如我们在下一章将看到的，PHP 中的对象支持并不完美，但只要遵守一定的原则，在使用语法时细心一点，你就可以真正使用 PHP 进行面向对象开发。

然而，本章开头描述的设计灾难仍然很常见。在 PHP 中，“设计”的身影似乎绝技，但显然现在越来越多的人开始关注设计。2001 年，`Leon Atkinson` 写了一点东西来介绍 PHP 和模式，而 `Harry Fuecks` 则在 2002 年开始运行网站 www.phppatterns.com （现在已停止更新）。基于设计模式的框架项目（如BinaryCloud）开始面世，还出现了一些自动测试和文档工具。

在 2003 年，PHP5 的第一个 beta 版本发布，这确保了 PHP 成为了一种面向对象编程语言。Zend Engine 2 提供了非常棒的对象支持。同样重要的是，这个版本的发布说明了对象和面向对象设计现在已经成为了 PHP 语言的核心部分。

多年以来，PHP5 一直在演变改进，例如引入了命名空间和闭包等重要的特性。再次期间，PHP5 已经成为服务器端 Web 编程的最佳之选。

2015 年 12 月 PHP7 发布了，代表了这一趋势的延续。特别是提供支持标量和返回类型声明——这是许多开发人员多年来一直呼唤加入的功能。如果你不知道这意味着什么以及它为什么这么重要，请继续阅读。


### 关于本书
本书不尝试开拓面向对象设计的新领域，而是打算站在巨人的肩膀上，介绍在 PHP 中如何应用良好的设计原则，实现一些关键的模式（并且是在四人组著作的经典图书 *Design Patterns*中介绍的模式）。然后，超越具体的代码实现，介绍那些有助于项目成功的工具和技术。除了本章和本书最后的简短总结之外，本书分为三个部分：对象、模式与实践。

#### 对象
在第二部分，我们首先看看 PHP 和对象的历史，从对 PHP3 回顾一直到 PHP5 的和新特性。

可能你是一个经验丰富、成功的 PHP 程序员，但不了解面向对象开发。因此，本书会从头解释对象、类和继承等。即使在这个早期阶段，也会介绍 PHP5 带来的一些面向对象新特性 以及 PHP7 中继续增强的部分。

打下基础之后，我们开始深入讨论主题，研究 PHP 中较高级的面向对象特性。我们也会用一章内容介绍 PHP 提供的帮助处理对象和类的工具。

但这还不够，你还要知道如何声明类，如何使用类来实例化对象。你要先规划好系统中的组成单元，并决定它们之间如何进行交互。学习这些比学习对象工具和语法要苦难的多。最后，我们将介绍用 PHP 进行面向对象的设计。


#### 模式

“模式”描述了软件设计中的问题，并提供解决方案的核心部分。我们所说的“解决方案”只是描述一个可以用来解决问题的方式，并不像代码参考手册那样直接提供代码让你来复制粘贴（尽管参考手册对程序员来说是很有用的资料）。介绍模式时我们可能会提供一个示例实现，但示例的重要性不如模式本身所阐述的概念。

第三部分首先给出设计模式的定义，并描述其结构。我们也会介绍某些模式流行的原因。

模式通常都遵循一定核心的设计原则。理解这些核心原则有助于分析一个模式的设计目的，也可应用于其他所有编程。我将介绍一些设计原则，也将介绍 UML（Unified Modeling Language 统一建模语言），它是一种与平台无关的描述类及其之间关系的方法。

本书并不想罗列出各种模式，只介绍最知名和实用的设计模式。对于每种设计模式，都描述问题，分析解决方案并给出 PHP 实现的代码示例。

#### 实践

如果没有妥善管理，那么即使有良好的架构，项目也可能失败。在第四部分中，我们将介绍帮助搭建开发框架的工具，以便确保项目的成功。如果本书其他部分是关于设计与编程的实践，那么第四部分就是关于管理代码的实践。我们介绍的工具可以构成一个项目的支持架构，可以帮助我们在错误发生时跟踪 bug，促进程序员间的交流，使代码易于安装、更加清晰。

我们之前提到过自动测试的威力。在第四部分中将首先介绍测试领域中所存在的问题及相应的解决方案。

很多程序员习惯于依靠自己来完成一切功能。`Composer` 与其主存储库 `Packagist` 一起提供了对成千上万个依赖关系管理包的访问，可以轻松将它们集成到项目中。 PEAR——一个质量经过严格控制的代码库，可以方便地用在项目中。我们将比较自己实现功能和直接利用 `composer` 软件包这两种不同做法。

尽管谈论到 `composer`，但是它的安装机制非常简单，只需要一句命令。

写代码是协作的过程，协作当然有好处，但有时候也会给你带来噩梦。`Git` 是一个分布式的版本控制系统，使得很多程序员可以在同一个代码库上协同工作，而不会覆盖彼此的工作。它允许你在开发的任何阶段都可以获取项目的快照，查看谁进行了哪些更改，并将项目拆分为可合并的分支。总有一天你 Git 会挽救一个项目。

当程序员对某些代码库合作开发时，他们经常会带来不用的约定和风格，这就影响到相互间的操作。不可否认的是互联网的创造力是由标准支撑的。通过遵守某些约定，我们就可以在一个不可想象的广阔沙箱中自由创作。所有，在新的章节中，介绍下 PHP 标准，它是如何帮助我们更好的编码以及为什么我们应该遵守这个标准。

有两个事实无法回避：bug 总是在代码中相同的区域重复出现，这有时让我们的工作好像时不时经历相同的场景，对于 bug 总有似曾相识的感觉；通常改进代码比修正 bug 带来更糟的后果。自动测试可以解决这两个问题，可以为系统提供早起的预警。我们将介绍 PHPUnit，它是一个由 xUnit 移植而来的强大的测试工具。xUnit 原本是用 Smalltalk 语言设计的，但后来衍生出了多个语言版本，最知名的是 Java 的 JUnit。我们将介绍 PHPUnit 的特性及使用 PHPUnit 的好处，也将讨论使用测试要付出的代价。 

应用程序是复杂多变的。我们可能需要安装文件到非标准路径，或者搭建数据库，或者修改服务器配置等。简而言之，完整的应用程序需要在安装过程中完成很多工作。Phing 是一个可以依赖的选择，它是 Java 工具 Ant 的 PHP 移植版本。Phing 和 Ant 会解析构建文件，然后按你告诉的方式处理源文件。这通常意味着从一个源代码目录中复制代码到几个不同的目的路径。但是如果你需要更加复杂的功能，Phing也可以很容易地进行扩展，从而满足要求。

有些公司统一开发平台，但是大多数情况下，团队成员最终运行的是一系列不同的操作系统。理想情况下，开发人员应该在于最终生产系统环境非常相似的环境中运行代码。`Vagrant` 一个使用虚拟化技术的应用程序，可以使团队成员保留他们特有的开发平台，兼具类似生产系统的环境中运行项目的能力。

测试和构建是很重要的，但你必须安装和运行测试，而且为了从中受益要持续这样做。如果构建和测试不能运行，就很容易懈怠，并一切都听之任之。在讨论持续集成的时候我们会介绍一些需要集成使用的工具和技术，通过它们可以实现构建和测试自动化。

#### 第五版新增内容

PHP 是一门活跃的语言，因而它一直在接受来自开发者的改进建议，也在不断发展。这个新版本经过了全面审校，涵盖了这门语言新的变化和各种可能性。比如说，这一版讨论了匿名类，以及期待已久的标量参数提示和返回类型。示例在适当的地方使用了 PHP7 的某些特性，所以请注意你需要基于 PHP7 的解释器运行代码。

之前的版本中，我介绍了关于 PEAR 包存储库的章节。现在 Composer 和 Packagist 存储库已经是 PHP 的事实标准了，我已经相应地重写了。

很高兴这次坚持使用 Git，我又花了点时间看了些 Git 仓库，比如 Github，因为开发人员越来越多地使用它。

包括一个关于前面提到的 Vagrant 的新章节

遵循 PHP 标准，我已经重写了书中的每个代码示例，以满足 PSR-1 和 PSR-2 标准，科技编辑 Paul Tregoing 的努力使我意识到这是个很大的承诺。

### 概要

这是一本关于面向对象设计和编码的书。也包含了涉及从协作到部署管理 PHP 代码库的工具

这两个主题从不同但互补的角度解决了同样的问题。首要目标就是构建一个实现其目的的系统，并使自己更好地协作发展。

第二个目标在于软件系统的美学设计。作为程序员，我们构建的是具有特定功能的软件。我们投入大量时间去编码，我们希望我们构建的工具，无论是单独的对象和类、软件组件还是最终产品，它们形成都优雅的整体。版本控制、测试、文档和构建的过程不仅支持这个目标，它还是我们最终整体的一部分。正如我们想要整洁的代码一样，我们都想要一个为开发人员和使用人员而设计的良好代码库。记住，共享，读取和部署项目应于代码本身一样重要。